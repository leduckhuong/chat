const themeBtn = $('.theme-icon');
const themeIcons = $('.theme-icon i');
const themes = $('#themes');
const overlayThemes = $('#overlayThemes');
const themeOptions = $('.theme-option');
const userTheme = localStorage.getItem('userTheme');
const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches;

if (themeBtn) {
    const updateThemeIcons = (id) => {
        themeIcons.addClass('hidden').eq(id).removeClass('hidden');
    };
    
    const updateThemeStyles = (id) => {
        $('html').toggleClass('dark', id === 1 || (id === 2 && systemTheme));
        localStorage.setItem('userTheme', id === 2 ? 'system' : (id === 1 ? 'dark' : 'light'));
        themeOptions.removeClass('text-sky-500').eq(id).addClass('text-sky-500');
    };
    
    function updateTheme() {
        const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (isDarkMode) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    }
    
    const toggleThemesMenu = () => {
        themes.toggleClass('hidden');
        overlayThemes.toggleClass('hidden');
    };
    
    themeOptions.each((index, theme) => {
        $(theme).on('click', (event) => {
            event.stopPropagation(); 
            updateThemeStyles(index);
            updateThemeIcons(index);
            toggleThemesMenu();
        });
    });
    
    themeBtn.click(() => {
        toggleThemesMenu();
    });
    overlayThemes.click((event) => {
        event.stopPropagation(); 
        toggleThemesMenu();
    });
    
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateTheme);
    
    (() => {
        const initialThemeId = userTheme === 'dark' ? 1 : userTheme === 'light' ? 0 : 2;
        updateThemeStyles(initialThemeId);
        updateThemeIcons(initialThemeId);
    })();
}
